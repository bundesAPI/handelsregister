name: Deploy Documentation

on:
  workflow_run:
    workflows: ["Lint", "Run Python üêç tests"]
    types:
      - completed
    branches:
      - main

jobs:
  # Check if docs changed and all checks passed
  check-and-deploy:
    runs-on: ubuntu-latest
    # Only proceed if the triggering workflow succeeded
    if: github.event.workflow_run.conclusion == 'success'
    permissions:
      contents: read
      pages: write
      id-token: write
      actions: read
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
      
      # Check if both required workflows have passed for this commit
      - name: Check workflow status
        id: check-workflows
        uses: actions/github-script@v7
        with:
          script: |
            const commitSha = context.payload.workflow_run.head_sha;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            // Get all workflow runs for this commit
            const { data: runs } = await github.rest.actions.listWorkflowRunsForRepo({
              owner,
              repo,
              head_sha: commitSha,
              per_page: 100
            });
            
            // Check if both Lint and test workflows passed
            const lintRun = runs.workflow_runs.find(run => run.name === 'Lint');
            const testRun = runs.workflow_runs.find(run => run.name === 'Run Python üêç tests');
            
            const bothPassed = 
              lintRun?.conclusion === 'success' && 
              testRun?.conclusion === 'success';
            
            core.setOutput('both-passed', bothPassed);
      
      # Check if docs changed in this commit
      - uses: dorny/paths-filter@v3
        id: filter
        if: steps.check-workflows.outputs.both-passed == 'true'
        with:
          filters: |
            docs:
              - 'docs/**'
              - 'mkdocs.yml'
      
      # Only deploy if docs actually changed and both workflows passed
      - name: Setup Python
        if: steps.filter.outputs.docs == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install dependencies
        if: steps.filter.outputs.docs == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[docs]"
      - name: Setup Pages
        if: steps.filter.outputs.docs == 'true'
        uses: actions/configure-pages@v5
      - name: Build with MkDocs
        if: steps.filter.outputs.docs == 'true'
        run: mkdocs build
      - name: Upload artifact
        if: steps.filter.outputs.docs == 'true'
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./site
      - name: Deploy to GitHub Pages
        if: steps.filter.outputs.docs == 'true'
        id: deployment
        uses: actions/deploy-pages@v4

